name: Android Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  android-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 50
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install Dioxus CLI
        run: cargo install dioxus-cli

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 36
          ndk-version: r25c
          cmake-version: '3.22.1'

      - name: Setup Android emulator
        timeout-minutes: 10
        run: |
          mkdir -p ~/.android/avd/Pixel_7_API_36.avd
          echo "Installing system image..."
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "system-images;android-36;google_apis;arm64-v8a" 2>&1 | tail -5 || true
          echo "Creating AVD configuration..."
          printf '%s\n' \
            'path=/root/.android/avd/Pixel_7_API_36.avd' \
            'path.rel=avd/Pixel_7_API_36.avd' \
            'target=android-36' \
            > ~/.android/avd/Pixel_7_API_36.ini
          printf '%s\n' \
            'avd.ini.encoding=UTF-8' \
            'hw.accelerometer=yes' \
            'hw.audioInput=yes' \
            'hw.battery=yes' \
            'hw.camera.back=virtualscene' \
            'hw.camera.front=emulated' \
            'hw.cpu.arch=arm64' \
            'hw.cpu.ncore=4' \
            'hw.device.hash2=d41d8cd98f00b204e9800998ecf8427e' \
            'hw.device.manufacturer=Google' \
            'hw.device.model=Pixel 7' \
            'hw.dPad=no' \
            'hw.gps=yes' \
            'hw.keyboard=yes' \
            'hw.lcd.density=420' \
            'hw.lcd.height=2400' \
            'hw.lcd.width=1080' \
            'hw.mainKeys=no' \
            'hw.ramSize=2048' \
            'hw.sensors.orientation=yes' \
            'hw.sensors.proximity=yes' \
            'hw.statusBar=yes' \
            'hw.touchScreen=yes' \
            'hw.useext4=yes' \
            'image.sysdir.1=system-images/android-36/google_apis/arm64-v8a/' \
            'runtime.network.latency=none' \
            'runtime.network.speed=full' \
            'showDeviceFrame=no' \
            'skin.dynamic=yes' \
            'skin.name=pixel_7' \
            'vm.heapSize=512' \
            > ~/.android/avd/Pixel_7_API_36.avd/config.ini
          echo "✓ AVD created"
          $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list avd 2>&1 | head -10 || true

      - name: Start Android emulator
        timeout-minutes: 15
        run: |
          echo "Starting emulator..."
          $ANDROID_HOME/emulator/emulator -avd Pixel_7_API_36 -no-window -no-audio -accel on -no-snapshot -no-boot-anim -verbose > emulator.log 2>&1 &
          sleep 15
          echo "=== Emulator log (first 30 lines) ==="
          head -30 emulator.log
          echo "Waiting for device..."
          for i in {1..120}; do
            if $ANDROID_HOME/platform-tools/adb devices 2>/dev/null | grep -q "device$"; then
              echo "✓ Device detected!"
              break
            fi
            [ $((i % 15)) -eq 0 ] && echo "Attempt $i/120..."
            sleep 5
          done
          echo "Waiting for boot..."
          for i in {1..60}; do
            if [ "$($ANDROID_HOME/platform-tools/adb shell getprop sys.boot_completed 2>/dev/null)" = "1" ]; then
              echo "✓ Boot completed!"
              break
            fi
            [ $((i % 10)) -eq 0 ] && echo "Boot attempt $i/60..."
            sleep 5
          done
          echo "Device ready:"
          $ANDROID_HOME/platform-tools/adb devices -l

      - name: Install dependencies
        run: cargo fetch

      - name: Build Android APK
        timeout-minutes: 25
        run: dx serve --package amp-android --android --release
        continue-on-error: true

      - name: Run tests
        timeout-minutes: 15
        run: cargo test --target aarch64-linux-android --no-run
        continue-on-error: true

      - name: Check logs on failure
        if: failure()
        run: |
          echo "=== Emulator log ==="
          tail -100 emulator.log || true
          echo "=== Device status ==="
          $ANDROID_HOME/platform-tools/adb devices || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/
          if-no-files-found: ignore

      - name: Upload emulator logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: emulator-logs
          path: emulator.log
          if-no-files-found: ignore

      - name: Stop emulator
        if: always()
        run: pkill -9 -f "emulator|qemu" || true

      - name: Summary
        if: always()
        run: |
          echo "✓ Workflow completed"
          echo "Emulator: Pixel_7_API_36"
          echo "Package: amp-android"