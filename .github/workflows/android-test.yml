name: Android Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  android-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Install Dioxus CLI
        timeout-minutes: 30
        run: |
          set -e
          echo "Installing Dioxus CLI..."
          cargo install dioxus-cli --locked
          dx --version

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            .gradle/caches
            .gradle/wrapper
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: ~/.android
          key: ${{ runner.os }}-android-sdk-api33-${{ hashFiles('.github/workflows/android-test.yml') }}
          restore-keys: |
            ${{ runner.os }}-android-sdk-

      - name: Accept Android SDK licenses
        timeout-minutes: 5
        run: |
          echo "Accepting Android SDK licenses non-interactively..."
          mkdir -p "$HOME/.android"
          touch "$HOME/.android/repositories.cfg"
          yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --licenses || true
          echo "License acceptance complete"

      - name: Setup Android SDK (API 33)
        timeout-minutes: 20
        run: |
          set -e
          echo "Setting up Android SDK..."
          ANDROID_SDK_ROOT="$ANDROID_HOME"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          
          # Install system image for API 33 (likely preinstalled or faster to download)
          echo "Installing system image for Android 33..."
          yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" \
            "system-images;android-33;google_apis;x86_64" || {
            echo "Warning: Could not install API 33, trying API 34..."
            yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" \
              "system-images;android-34;google_apis;x86_64" || {
              echo "Error: Failed to install any system image"
              exit 1
            }
          }
          
          echo "System image installed successfully"
          echo "Listing installed system images:"
          ls -la "$ANDROID_HOME/system-images/" || true

      - name: Setup Android emulator
        timeout-minutes: 15
        run: |
          set -e
          echo "Setting up Android emulator..."
          
          # Determine which API level is available
          API_LEVEL=33
          if [ ! -d "$ANDROID_HOME/system-images/android-33" ]; then
            echo "API 33 not found, using API 34"
            API_LEVEL=34
          fi
          
          AVD_NAME="TestDevice"
          AVD_PATH="$HOME/.android/avd/${AVD_NAME}.avd"
          
          # Remove old AVD if exists
          if [ -d "$AVD_PATH" ]; then
            echo "Removing old AVD..."
            rm -rf "$AVD_PATH"
          fi
          
          echo "Creating AVD with API level $API_LEVEL..."
          mkdir -p "$AVD_PATH"
          
          # Create config.ini
          cat > "$AVD_PATH/config.ini" << 'AVDCONFIG'
          avd.ini.encoding=UTF-8
          hw.accelerometer=yes
          hw.audioInput=yes
          hw.battery=yes
          hw.camera.back=virtualscene
          hw.camera.front=emulated
          hw.cpu.arch=x86_64
          hw.cpu.ncore=4
          hw.device.hash=2d41d8cd98f00b204e9800998ecf8427e
          hw.device.manufacturer=Google
          hw.device.model=Pixel 4a
          hw.dPad=no
          hw.gps=yes
          hw.keyboard=yes
          hw.lcd.density=420
          hw.lcd.height=2340
          hw.lcd.width=1080
          hw.mainKeys=no
          hw.ramSize=4096
          hw.sensors.orientation=yes
          hw.sensors.proximity=yes
          hw.statusBar=yes
          hw.touchScreen=yes
          hw.useext4=yes
          runtime.network.latency=none
          runtime.network.speed=full
          showDeviceFrame=no
          vm.heapSize=576
          AVDCONFIG
          
          # Append the system image path dynamically
          echo "image.sysdir.1=system-images/android-${API_LEVEL}/google_apis/x86_64" >> "$AVD_PATH/config.ini"
          
          # Create AVD ini file
          echo "iniversion=1.0" > "$HOME/.android/avd/${AVD_NAME}.ini"
          echo "path=$AVD_PATH" >> "$HOME/.android/avd/${AVD_NAME}.ini"
          echo "target=android-${API_LEVEL}" >> "$HOME/.android/avd/${AVD_NAME}.ini"
          
          echo "AVD created at: $AVD_PATH"
          ls -la "$AVD_PATH"

      - name: Start Android emulator
        timeout-minutes: 25
        run: |
          set -e
          AVD_NAME="TestDevice"
          EMULATOR_LOG="$PWD/emulator.log"
          
          echo "Starting emulator..."
          nohup "$ANDROID_HOME/emulator/emulator" \
            -avd "$AVD_NAME" \
            -no-window \
            -no-audio \
            -accel on \
            -no-snapshot \
            -no-boot-anim \
            -verbose \
            -no-metrics \
            -memory 4096 \
            -cores 4 \
            > "$EMULATOR_LOG" 2>&1 &
          
          EMULATOR_PID=$!
          echo "Emulator PID: $EMULATOR_PID"
          echo "$EMULATOR_PID" > emulator.pid
          
          sleep 5
          echo "Checking emulator process..."
          if ! kill -0 $EMULATOR_PID 2>/dev/null; then
            echo "ERROR: Emulator process died immediately!"
            head -100 "$EMULATOR_LOG"
            exit 1
          fi
          
          echo "Waiting for adb to detect emulator..."
          TIMEOUT=120
          CONNECTED=0
          
          for i in $(seq 1 $TIMEOUT); do
            if "$ANDROID_HOME/platform-tools/adb" devices | grep -q emulator-5554; then
              echo "✓ Emulator detected on port 5554"
              CONNECTED=1
              break
            fi
            
            if [ $((i % 10)) -eq 0 ]; then
              echo "Attempt $i/$TIMEOUT: Waiting for adb connection..."
              "$ANDROID_HOME/platform-tools/adb" devices
            fi
            
            if ! kill -0 $EMULATOR_PID 2>/dev/null; then
              echo "ERROR: Emulator process died while waiting for adb!"
              tail -100 "$EMULATOR_LOG"
              exit 1
            fi
            
            sleep 1
          done
          
          if [ $CONNECTED -eq 0 ]; then
            echo "ERROR: Emulator not detected after ${TIMEOUT}s"
            echo "Recent emulator log:"
            tail -50 "$EMULATOR_LOG"
            echo ""
            echo "ADB devices:"
            "$ANDROID_HOME/platform-tools/adb" devices
            exit 1
          fi
          
          echo "Waiting for boot to complete..."
          TIMEOUT=120
          BOOT_COMPLETE=0
          
          for i in $(seq 1 $TIMEOUT); do
            BOOT_PROP=$("$ANDROID_HOME/platform-tools/adb" shell getprop sys.boot_completed 2>/dev/null || echo "0")
            
            if [ "$BOOT_PROP" = "1" ]; then
              echo "✓ Boot completed!"
              BOOT_COMPLETE=1
              break
            fi
            
            if [ $((i % 15)) -eq 0 ]; then
              echo "Attempt $i/$TIMEOUT: Waiting for boot completion (sys.boot_completed=$BOOT_PROP)..."
            fi
            
            sleep 1
          done
          
          if [ $BOOT_COMPLETE -eq 0 ]; then
            echo "ERROR: Boot did not complete after ${TIMEOUT}s"
            echo "Boot property: $BOOT_PROP"
            tail -50 "$EMULATOR_LOG"
            exit 1
          fi
          
          echo ""
          echo "Device ready! Final status:"
          "$ANDROID_HOME/platform-tools/adb" devices -l
          "$ANDROID_HOME/platform-tools/adb" shell getprop ro.build.version.release

      - name: Build Android APK with Dioxus CLI
        timeout-minutes: 30
        run: |
          set -e
          echo "Building Android APK using Dioxus CLI..."
          dx build --android --release --bundle android --package amp-android
          
          echo ""
          echo "Build completed successfully!"
          echo "APK location:"
          find target/dx -name "*.apk" -type f 2>/dev/null | head -5

      - name: Install APK on emulator
        timeout-minutes: 10
        run: |
          set -e
          echo "Installing APK on emulator..."
          
          # Find the built APK
          APK_PATH=$(find target/dx/amp/release/android -name "app-release.apk" -o -name "app-debug.apk" | head -1)
          
          if [ -z "$APK_PATH" ]; then
            echo "ERROR: APK not found!"
            echo "Searching in target/dx/amp/release/android:"
            find target/dx/amp/release/android -type f -name "*.apk" || true
            exit 1
          fi
          
          echo "Found APK: $APK_PATH"
          echo "Installing APK..."
          "$ANDROID_HOME/platform-tools/adb" install -r "$APK_PATH"
          
          echo ""
          echo "✓ APK installed successfully!"

      - name: Verify app installation
        timeout-minutes: 10
        run: |
          set -e
          echo "Verifying app installation..."
          
          # Check if amp package is installed
          echo "Checking installed packages..."
          "$ANDROID_HOME/platform-tools/adb" shell pm list packages | grep amp || {
            echo "Warning: amp package not found in pm list"
          }
          
          echo ""
          echo "Device logcat (last 50 lines):"
          "$ANDROID_HOME/platform-tools/adb" logcat -d | tail -50

      - name: Check device and logs on failure
        if: failure()
        run: |
          echo "=== ADB Devices ==="
          "$ANDROID_HOME/platform-tools/adb" devices -l || true
          
          echo ""
          echo "=== Last 100 lines of emulator log ==="
          tail -100 emulator.log || true
          
          echo ""
          echo "=== Device logcat (last 100 lines) ==="
          "$ANDROID_HOME/platform-tools/adb" logcat -d 2>/dev/null | tail -100 || true
          
          echo ""
          echo "=== System boot properties ==="
          "$ANDROID_HOME/platform-tools/adb" shell getprop | grep -E "boot|init\.svc" || true

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: target/dx/
          if-no-files-found: ignore

      - name: Upload emulator logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: emulator-logs
          path: emulator.log
          if-no-files-found: ignore

      - name: Stop emulator
        if: always()
        run: |
          echo "Stopping emulator..."
          pkill -9 -f emulator || true
          pkill -9 -f qemu || true
          "$ANDROID_HOME/platform-tools/adb" kill-server || true
          sleep 2
          
          if [ -f emulator.pid ]; then
            PID=$(cat emulator.pid)
            kill -9 "$PID" 2>/dev/null || true
          fi

      - name: Workflow summary
        if: always()
        run: |
          echo "=== Workflow Summary ==="
          echo "Android emulator: TestDevice"
          echo "SDK API level: 33 or 34"
          echo "Architecture: x86_64"
          echo "Build tool: Dioxus CLI (dx)"
          echo "Timeout: 90 minutes"
          echo ""
          echo "If tests failed, check artifacts:"
          echo "  - emulator-logs: emulator.log"
          echo "  - android-build: target/dx/"
