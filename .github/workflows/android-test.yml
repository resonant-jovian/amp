name: Android Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  android-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install Dioxus CLI
        run: cargo install dioxus-cli

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 36
          ndk-version: r25c
          cmake-version: '3.22.1'

      - name: Setup Android emulator
        timeout-minutes: 10
        run: |
          mkdir -p ~/.android/avd/Pixel_7_API_36.avd
          echo "Installing x86_64 system image..."
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "system-images;android-36;google_apis;x86_64" 2>&1 | tail -5 || true
          echo "Creating AVD configuration..."
          printf '%s\n' \
            'path=/root/.android/avd/Pixel_7_API_36.avd' \
            'path.rel=avd/Pixel_7_API_36.avd' \
            'target=android-36' \
            > ~/.android/avd/Pixel_7_API_36.ini
          printf '%s\n' \
            'avd.ini.encoding=UTF-8' \
            'hw.accelerometer=yes' \
            'hw.audioInput=yes' \
            'hw.battery=yes' \
            'hw.camera.back=virtualscene' \
            'hw.camera.front=emulated' \
            'hw.cpu.arch=x86_64' \
            'hw.cpu.ncore=4' \
            'hw.device.hash2=d41d8cd98f00b204e9800998ecf8427e' \
            'hw.device.manufacturer=Google' \
            'hw.device.model=Pixel 7' \
            'hw.dPad=no' \
            'hw.gps=yes' \
            'hw.keyboard=yes' \
            'hw.lcd.density=420' \
            'hw.lcd.height=2400' \
            'hw.lcd.width=1080' \
            'hw.mainKeys=no' \
            'hw.ramSize=4096' \
            'hw.sensors.orientation=yes' \
            'hw.sensors.proximity=yes' \
            'hw.statusBar=yes' \
            'hw.touchScreen=yes' \
            'hw.useext4=yes' \
            'image.sysdir.1=system-images/android-36/google_apis/x86_64/' \
            'runtime.network.latency=none' \
            'runtime.network.speed=full' \
            'showDeviceFrame=no' \
            'vm.heapSize=576' \
            > ~/.android/avd/Pixel_7_API_36.avd/config.ini
          echo "✓ AVD created"

      - name: Start Android emulator
        timeout-minutes: 20
        run: |
          echo "Starting emulator..."
          nohup $ANDROID_HOME/emulator/emulator \
            -avd Pixel_7_API_36 \
            -no-window \
            -no-audio \
            -accel on \
            -no-snapshot \
            -no-boot-anim \
            -verbose \
            -no-metrics \
            > emulator.log 2>&1 &
          
          EMULATOR_PID=$!
          echo "Emulator PID: $EMULATOR_PID"
          sleep 15
          
          echo "=== Emulator startup log ==="
          head -50 emulator.log || true
          
          echo ""
          echo "Killing any stale adb daemons..."
          pkill -9 adb || true
          sleep 2
          
          echo "Starting fresh adb daemon..."
          $ANDROID_HOME/platform-tools/adb start-server
          sleep 3
          
          echo "Waiting for device connection (10 minutes timeout)..."
          CONNECTED=0
          for i in {1..120}; do
            if $ANDROID_HOME/platform-tools/adb devices | grep -q "emulator-5554"; then
              echo "✓ Emulator detected on port 5554!"
              CONNECTED=1
              break
            fi
            if [ $((i % 10)) -eq 0 ]; then
              echo "Attempt $i/120 - Current devices:"
              $ANDROID_HOME/platform-tools/adb devices || true
            fi
            sleep 5
          done
          
          if [ $CONNECTED -eq 0 ]; then
            echo "✗ Device not found after 10 minutes"
            echo "=== Full emulator log ==="
            cat emulator.log || true
            exit 1
          fi
          
          echo ""
          echo "Waiting for boot_completed (10 minutes timeout)..."
          for i in {1..120}; do
            BOOT=$($ANDROID_HOME/platform-tools/adb shell getprop sys.boot_completed 2>/dev/null || echo "")
            if [ "$BOOT" = "1" ]; then
              echo "✓ Boot completed!"
              break
            fi
            if [ $((i % 15)) -eq 0 ]; then
              echo "Boot attempt $i/120..."
            fi
            sleep 5
          done
          
          echo ""
          echo "Device ready. Final check:"
          $ANDROID_HOME/platform-tools/adb devices -l
          $ANDROID_HOME/platform-tools/adb shell getprop ro.build.version.release || true

      - name: Install dependencies
        run: cargo fetch

      - name: Build Android APK
        timeout-minutes: 25
        run: dx serve --package amp-android --android --release
        continue-on-error: true

      - name: Run tests
        timeout-minutes: 15
        run: cargo test --target aarch64-linux-android --no-run
        continue-on-error: true

      - name: Check logs on failure
        if: failure()
        run: |
          echo "=== Last 150 lines of emulator log ==="
          tail -150 emulator.log || true
          echo ""
          echo "=== ADB devices ==="
          $ANDROID_HOME/platform-tools/adb devices || true
          echo ""
          echo "=== Device logcat ==="
          $ANDROID_HOME/platform-tools/adb logcat -d 2>/dev/null | tail -100 || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/
          if-no-files-found: ignore

      - name: Upload emulator logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: emulator-logs
          path: emulator.log
          if-no-files-found: ignore

      - name: Stop emulator
        if: always()
        run: |
          echo "Stopping emulator..."
          pkill -9 -f "emulator" || true
          pkill -9 -f "qemu" || true
          $ANDROID_HOME/platform-tools/adb kill-server || true
          sleep 2

      - name: Summary
        if: always()
        run: |
          echo "✓ Workflow completed"
          echo "Emulator: Pixel_7_API_36 (x86_64)"
          echo "Package: amp-android"