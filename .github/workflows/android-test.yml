name: Android Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  android-build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          log-accepted-android-sdk-licenses: true

      - name: Install Dioxus CLI
        run: cargo install dioxus-cli@0.7.3 --locked

      - name: Create keystore.properties
        run: |
          cat > keystore.properties << 'EOF'
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=${{ secrets.ANDROID_KEYSTORE_FILE }}
          EOF
          chmod 600 keystore.properties

      - name: Decode and save keystore file
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > release.jks
          chmod 600 release.jks

      - name: Make scripts executable
        run: |
          chmod +x scripts/build.sh
          chmod +x scripts/serve.sh
          chmod +x scripts/adb-install.sh

      - name: Build Android APK
        run: ./scripts/build.sh
        env:
          GRADLE_OPTS: "-Xmx4096m"

      - name: List build outputs
        if: always()
        run: |
          echo "=== Build Artifacts ==="
          find target/dx/amp/release/android/app/app/build/outputs/bundle/release -type f -name "*.apk" 2>/dev/null || echo "No APK found"
          find target/dx/amp/release/android/app/app/build/outputs/bundle/release -type f -name "*.aab" 2>/dev/null || echo "No AAB found"

      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: amp-release-apk
          path: target/dx/amp/release/android/app/app/build/outputs/apk/release/*.apk
          retention-days: 30
          if-no-files-found: warn

      - name: Upload AAB artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: amp-release-aab
          path: target/dx/amp/release/android/app/app/build/outputs/bundle/release/*.aab
          retention-days: 30
          if-no-files-found: warn

      - name: Generate build summary
        if: always()
        run: |
          echo "## Android Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Java Version:** 21" >> $GITHUB_STEP_SUMMARY
          echo "**Build Tool:** Dioxus CLI 0.7.3" >> $GITHUB_STEP_SUMMARY
          echo "**Target SDK:** 36" >> $GITHUB_STEP_SUMMARY
          echo "**Min SDK:** 21" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ]; then
            APK_COUNT=$(find target/dx/amp/release/android/app/build/outputs/apk/release -name "*.apk" 2>/dev/null | wc -l)
            echo "**APKs Generated:** $APK_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
