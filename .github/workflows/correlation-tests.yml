name: Correlation Algorithm Tests

on:
  push:
    branches:
      - main
    paths:
      - 'core/src/correlation_algorithms/**'
      - 'core/src/correlation_tests.rs'
      - 'core/src/structs.rs'
      - 'core/src/api.rs'
      - 'core/Cargo.toml'
      - '.github/workflows/correlation-tests.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'core/src/correlation_algorithms/**'
      - 'core/src/correlation_tests.rs'
      - 'core/src/structs.rs'
      - 'core/src/api.rs'
      - 'core/Cargo.toml'
  workflow_dispatch:

jobs:
  test:
    name: Test Correlation Algorithms
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-index-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-target-

      - name: Fetch dependencies
        working-directory: ./core
        run: cargo fetch

      - name: Run tests (debug)
        working-directory: ./core
        run: cargo test --lib correlation_tests -- --nocapture --test-threads=1

      - name: Run tests (release)
        working-directory: ./core
        run: cargo test --lib correlation_tests --release -- --nocapture --test-threads=1
        if: success()

      - name: Run clippy
        working-directory: ./core
        run: cargo clippy -- -D warnings

      - name: Generate test list
        working-directory: ./core
        run: |
          cargo test --lib correlation_tests -- --nocapture --list > test_list.txt 2>&1 || true
          cat test_list.txt
        if: always()

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: correlation-test-results
          path: |
            core/test_list.txt
          if-no-files-found: ignore
          retention-days: 14

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    if: always()
    needs: test
    
    steps:
      - name: Print test summary
        run: |
          echo "# ✅ Correlation Algorithm Tests Summary"
          echo ""
          echo "## Algorithms Tested"
          echo "- ✅ Distance-Based (perpendicular distance to line segments)"
          echo "- ✅ Raycasting (36-ray intersection method)"
          echo "- ✅ Overlapping Chunks (spatial grid with overlap)"
          echo "- ✅ R-Tree Spatial Index (binary space partitioning)"
          echo "- ✅ KD-Tree Spatial Index (2D binary partition tree)"
          echo "- ✅ Grid Nearest Neighbor (uniform spatial grid)"
          echo ""
          echo "## Test Coverage"
          echo "- Haversine distance accuracy (WGS84 great-circle)"
          echo "- 50m threshold enforcement"
          echo "- Algorithm consistency (all find same zone)"
          echo "- Dual dataset correlation (miljö + parkering)"
          echo "- Batch processing (100+ addresses)"
          echo "- Real-world Malmö coordinates"
          echo "- Deterministic results"
          echo "- Degenerate segment handling"
          echo ""
          echo "## Threshold Validation"
          echo "- All distances calculated in meters (not degrees)"
          echo "- 50m maximum distance enforced"
          echo "- Returns only valid matches within threshold"
          echo ""
          echo "## Status"
          echo "Result: ${{ needs.test.result }}"
