<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMP Origo Map</title>
    
    <!-- Origo CSS -->
    <link rel="stylesheet" href="https://raw.githubusercontent.com/origo-map/origo/master/css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.5.0/ol.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        #map {
            width: 100%;
            height: 100%;
            background: #f5f5f5;
        }
        #map canvas {
            display: block;
        }
        .map-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            font-size: 12px;
            z-index: 100;
            max-width: 250px;
            color: #333;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="map-info" id="mapInfo">Loading map...</div>
    
    <!-- OpenLayers -->
    <script src="https://cdn.jsdelivr.net/npm/ol@7.5.0/dist/ol.min.js"></script>
    
    <!-- Origo -->
    <script src="https://raw.githubusercontent.com/origo-map/origo/master/origo.js"></script>
    
    <script>
        // Configuration for Malm√∂ map (SWEREF 99 13 30 - EPSG:3008)
        const origConfig = {
            projectionCode: 'EPSG:3008',
            projectionExtent: [-72234.21, 6098290.04, 573714.68, 7702218.01],
            proj4Defs: [
                {
                    code: 'EPSG:3008',
                    projection: '+proj=tmerc +lat_0=0 +lon_0=13.5 +k=1 +x_0=150000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs',
                    alias: 'SWEREF 99 1330'
                }
            ],
            extent: [34364.701176279224, 6105850.2404539045, 180404.6059212964, 6198940.128187204],
            center: [120844, 6161226],
            zoom: 3,
            constrainResolution: true,
            resolutions: [
                66.6751333502667, 33.86673440013547, 25.400050800101603, 16.933367200067735,
                12.700025400050801, 8.466683600033868, 4.233341800016934, 2.116670900008467,
                1.0583354500042335, 0.5291677250021167, 0.26458386250105836
            ],
            controls: [
                { name: 'home', options: { zoomOnStart: true } },
                { name: 'mapmenu', options: { isActive: false } },
                { name: 'search', options: {
                    url: 'https://geo.malmo.se/api/search',
                    searchAttribute: 'NAMN',
                    titleAttribute: 'TYPE',
                    contentAttribute: 'NAMN',
                    geometryAttribute: 'GEOM',
                    hintText: 'S√∂k adress...',
                    minLength: 2,
                    groupSuggestions: true,
                    maxZoomLevel: '8'
                } }
            ],
            pageSettings: { footer: { img: 'img/malmo-logo.png', url: 'https://malmo.se' } },
            featureinfoOptions: { infowindow: 'overlay', pinning: false, hitTolerance: 10 },
            
            // Source definitions
            source: {
                'bakgrund': {
                    url: 'https://gis.malmo.se/arcgis/rest/services/baskartor/Bakgrundskarta_nedtonad_3008_text/MapServer/tile/{z}/{y}/{x}',
                    tileGrid: {
                        resolutions: [66.6751333502667, 33.86673440013547, 25.400050800101603, 16.933367200067735, 12.700025400050801, 8.466683600033868, 4.233341800016934, 2.116670900008467, 1.0583354500042335, 0.5291677250021167, 0.26458386250105836, 0.13229193125052918, 0.06614596562526459, 0.026458386250105836],
                        origin: [-399.9999999999999, 9006799.254740989],
                        extent: [-1678505.1838360203, 4665380, 2431912.7361639794, 8775797.92]
                    }
                },
                'wms-malmo': {
                    url: 'https://stadsatlas.malmo.se/geoserver/malmows/wms',
                    type: 'WMS'
                }
            },
            
            // Groups
            groups: [
                { name: 'background', title: 'Bakgrundskartor', groups: [] },
                { name: 'data', title: 'Data', groups: [] }
            ],
            
            // Layers
            layers: [
                {
                    name: 'bakgrundskarta',
                    title: 'Bakgrundskarta',
                    group: 'background',
                    source: 'bakgrund',
                    type: 'XYZ',
                    visible: true,
                    queryable: false,
                    attribution: '¬© Malm√∂ stad'
                },
                {
                    name: 'miljodata',
                    title: 'Milj√∂parkering',
                    group: 'data',
                    source: 'wms-malmo',
                    type: 'WMS',
                    layers: 'malmows:Miljoparkering',
                    visible: true,
                    transparent: true,
                    opacity: 0.7
                },
                {
                    name: 'address-pin',
                    title: 'Adressmark√∂rer',
                    group: 'data',
                    type: 'Vector',
                    visible: true,
                    zIndex: 1000,
                    style: {
                        icon: {
                            src: 'data:image/svg+xml;utf8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2232%22 height=%2244%22 viewBox=%220 0 32 44%22%3E%3Cdefs%3E%3Cfilter id=%22shadow%22%3E%3CfeDropShadow dx=%220%22 dy=%222%22 stdDeviation=%222%22 flood-opacity=%220.3%22/%3E%3C/filter%3E%3C/defs%3E%3Cpath d=%22M16 2 C9 2, 3 8, 3 16 C3 26, 16 44, 16 44 S29 26, 29 16 C29 8, 23 2, 16 2%22 fill=%22%23FF4444%22 stroke=%22white%22 stroke-width=%222.5%22 filter=%22url(%23shadow)%22/%3E%3Ccircle cx=%2216%22 cy=%2215%22 r=%226%22 fill=%22white%22 stroke=%22%23FF4444%22 stroke-width=%221.5%22/%3E%3C/svg%3E',
                            scale: 1.2,
                            anchor: [0.5, 1]
                        }
                    }
                }
            ]
        };
        
        // Parse URL parameters
        const params = new URLSearchParams(window.location.hash.substring(1));
        const centerStr = params.get('center');
        const zoom = parseInt(params.get('zoom')) || 18;
        
        let mapCenterX = 120844;
        let mapCenterY = 6161226;
        
        if (centerStr) {
            const coords = centerStr.split(',').map(c => parseFloat(c.trim()));
            if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                mapCenterX = coords[0];
                mapCenterY = coords[1];
            }
        }
        
        console.log('üó∫Ô∏è Origo Map: Center=[' + mapCenterX + ',' + mapCenterY + '], Zoom=' + zoom);
        
        let mapInstance = null;
        
        // Wait for Origo to load
        const checkOrigoReady = setInterval(() => {
            if (window.o && typeof window.o.create === 'function') {
                clearInterval(checkOrigoReady);
                initializeMap();
            }
        }, 100);
        
        // Timeout after 10 seconds
        setTimeout(() => {
            if (!mapInstance) {
                clearInterval(checkOrigoReady);
                document.getElementById('mapInfo').innerHTML = '‚ùå Failed to load Origo library';
                console.error('‚ùå Origo library failed to load after 10 seconds');
            }
        }, 10000);
        
        function initializeMap() {
            try {
                console.log('‚úÖ Origo library detected, initializing map...');
                
                // Create map
                mapInstance = window.o.create({
                    target: 'map',
                    ...origConfig,
                    center: [mapCenterX, mapCenterY],
                    zoom: zoom
                });
                
                console.log('‚úÖ Map created');
                
                // Add address marker
                setTimeout(() => {
                    addAddressPin(mapCenterX, mapCenterY);
                    enableLayers();
                    updateMapInfo(mapCenterX, mapCenterY);
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Map initialization error:', error);
                document.getElementById('mapInfo').innerHTML = '‚ùå Map error: ' + error.message;
            }
        }
        
        function addAddressPin(x, y) {
            try {
                if (!mapInstance) {
                    console.warn('‚ö†Ô∏è Map not ready yet');
                    return;
                }
                
                // Find or create pin layer
                const layers = mapInstance.getLayers();
                let pinLayer = null;
                
                // Search for address-pin layer
                layers.getArray().forEach(layer => {
                    if (layer.get('name') === 'address-pin') {
                        pinLayer = layer;
                    }
                });
                
                // Create vector source and layer if not found
                if (!pinLayer) {
                    console.log('üìç Creating pin layer...');
                    const vectorSource = new ol.source.Vector();
                    pinLayer = new ol.layer.Vector({
                        source: vectorSource,
                        zIndex: 1000
                    });
                    pinLayer.set('name', 'address-pin');
                    mapInstance.addLayer(pinLayer);
                }
                
                // Add feature to layer
                const source = pinLayer.getSource();
                if (source) {
                    const feature = new ol.Feature({
                        geometry: new ol.geom.Point([x, y])
                    });
                    
                    feature.setStyle(new ol.style.Style({
                        image: new ol.style.Icon({
                            anchor: [0.5, 1],
                            anchorXUnits: 'fraction',
                            anchorYUnits: 'fraction',
                            scale: 1.2,
                            src: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="44" viewBox="0 0 32 44">
                                    <defs>
                                        <filter id="shadow">
                                            <feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.3"/>
                                        </filter>
                                    </defs>
                                    <path d="M16 2 C9 2, 3 8, 3 16 C3 26, 16 44, 16 44 S29 26, 29 16 C29 8, 23 2, 16 2" fill="#FF4444" stroke="white" stroke-width="2.5" filter="url(#shadow)"/>
                                    <circle cx="16" cy="15" r="6" fill="white" stroke="#FF4444" stroke-width="1.5"/>
                                </svg>
                            `)
                        })
                    }));
                    
                    source.addFeature(feature);
                    pinLayer.setVisible(true);
                    console.log('‚úÖ Pin added at [' + x + ',' + y + ']');
                }
            } catch (error) {
                console.error('‚ùå Error adding pin:', error);
            }
        }
        
        function enableLayers() {
            try {
                if (!mapInstance) return;
                
                console.log('üîß Enabling layers...');
                const layers = mapInstance.getLayers();
                
                layers.getArray().forEach(layer => {
                    const name = layer.get('name');
                    
                    // Enable background
                    if (name === 'bakgrundskarta') {
                        layer.setVisible(true);
                        console.log('‚úÖ Enabled: Bakgrundskarta');
                    }
                    
                    // Enable milj√∂data
                    if (name === 'miljodata') {
                        layer.setVisible(true);
                        console.log('‚úÖ Enabled: Milj√∂data');
                    }
                    
                    // Enable pins
                    if (name === 'address-pin') {
                        layer.setVisible(true);
                        console.log('‚úÖ Enabled: Address pins');
                    }
                });
            } catch (error) {
                console.error('‚ùå Error enabling layers:', error);
            }
        }
        
        function updateMapInfo(x, y) {
            const info = document.getElementById('mapInfo');
            info.innerHTML = 'üìç Origo Map Ready<br>X: ' + x.toFixed(2) + '<br>Y: ' + y.toFixed(2) + '<br>Zoom: ' + (mapInstance ? mapInstance.getView().getZoom() : '?');
        }
        
        // Update info on zoom changes
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (mapInstance) {
                    mapInstance.getView().on('change:resolution', () => {
                        updateMapInfo(mapCenterX, mapCenterY);
                    });
                    console.log('‚úÖ Map fully initialized and ready');
                }
            }, 1000);
        });
    </script>
</body>
</html>