<!DOCTYPE html>
<html>
<head>
    <title>AMP Correlation Map - Direct Origo Embed</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stadsatlas.malmo.se/stadsatlas/css/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <script src="https://stadsatlas.malmo.se/stadsatlas/js/origo.js"></script>
    <script>
        // Parse URL parameters to get address coordinates
        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const centerStr = urlParams.get('center');
        const zoom = parseInt(urlParams.get('zoom')) || 18;
        
        let x = 120844;  // Default center
        let y = 6161226;
        
        // Parse center coordinates
        if (centerStr) {
            const coords = centerStr.split(',');
            if (coords.length === 2) {
                x = parseFloat(coords[0]);
                y = parseFloat(coords[1]);
            }
        }
        
        // Initialize Origo with StadsAtlas config
        fetch('https://stadsatlas.malmo.se/stadsatlas/index.json')
            .then(response => response.json())
            .then(config => {
                // Enable background layer by default
                config.layers = config.layers || [];
                
                // Find and enable background layer
                const bgLayers = config.layers.filter(l => 
                    l.name && (
                        l.name.toLowerCase().includes('bakgrund') ||
                        l.name.toLowerCase().includes('background')
                    )
                );
                
                // Mark these layers as visible in the config
                bgLayers.forEach(layer => {
                    layer.visible = true;  // Enable by default
                });
                
                // Find and enable miljöparkering/miljödata layer
                const miljöLayers = config.layers.filter(l =>
                    l.name && (
                        l.name.toLowerCase().includes('miljo') ||
                        l.name.toLowerCase().includes('parkering')
                    )
                );
                
                miljöLayers.forEach(layer => {
                    layer.visible = true;  // Enable by default
                });
                
                // Create map with modified config
                const map = o.create({
                    target: 'map',
                    ...config,
                    center: [x, y],
                    zoom: zoom,
                    resolutions: config.resolutions
                });
                
                // After map initializes, explicitly show background layers
                map.on('load', function() {
                    // Get all layers and enable background
                    const allLayers = map.getLayers().getArray();
                    
                    allLayers.forEach(layer => {
                        const layerName = layer.get('name') || '';
                        
                        // Show background layers
                        if (layerName.toLowerCase().includes('bakgrund') ||
                            layerName.toLowerCase().includes('background')) {
                            layer.setVisible(true);
                            console.log('Enabled background layer:', layerName);
                        }
                        
                        // Show miljödata layers
                        if (layerName.toLowerCase().includes('miljo') ||
                            layerName.toLowerCase().includes('parkering')) {
                            layer.setVisible(true);
                            console.log('Enabled miljö layer:', layerName);
                        }
                    });
                    
                    console.log('Map loaded. Center:', [x, y], 'Zoom:', zoom);
                });
            })
            .catch(error => {
                console.error('Failed to load StadsAtlas config:', error);
                // Fallback: create basic map
                const map = o.create({
                    target: 'map',
                    center: [x, y],
                    zoom: zoom
                });
            });
    </script>
</body>
</html>
