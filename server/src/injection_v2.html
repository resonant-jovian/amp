<script>
/**
 * StadsAtlas Injection Script v2
 * Based on accessibility tree analysis
 * Strategy: Click menu → Find Miljöparkering → Toggle visibility → Search
 */

let injectionPhase = 0;
const MAX_WAIT_TIME = 15000; // 15 seconds total
const PHASE_TIMEOUT = 3000; // 3 seconds per phase

// Known button IDs from accessibility tree
const BUTTON_IDS = {
  MENU: '#cmkv2kcmk000g206jepb76w85',
  ZOOM_IN: '#cmkv2kcmj0004206jnnm2ygxd',
  ZOOM_OUT: '#cmkv2kcmj0006206js5fq58t2',
  HOME: '#cmkv2kcmk000d206je8eyd0w0',
  GEO: '#cmkv2kcmk001f206jzya5lsbh'
};

window.addEventListener('load', () => {
  console.log('[AMP] Page loaded, starting injection sequence...');
  startInjectionSequence();
});

function startInjectionSequence() {
  injectionPhase = 1;
  console.log('[AMP] Phase 1: Clicking menu button');
  clickMenuButton();
}

function clickMenuButton() {
  setTimeout(() => {
    const menuBtn = document.querySelector(BUTTON_IDS.MENU);
    if (menuBtn) {
      console.log('[AMP] ✓ Found menu button, clicking...');
      menuBtn.click();
      // Give menu time to open
      setTimeout(findMiljoparkeringLayer, 500);
    } else {
      console.log('[AMP] ✗ Menu button not found, retrying...');
      if (Date.now() - window.injectionStart < MAX_WAIT_TIME) {
        setTimeout(clickMenuButton, 500);
      }
    }
  }, 100);
}

function findMiljoparkeringLayer() {
  console.log('[AMP] Phase 2: Looking for Miljöparkering layer...');
  injectionPhase = 2;
  
  // Get the address to search for
  const addressElement = document.querySelector('.header .address');
  const address = addressElement ? addressElement.textContent.trim() : '';
  
  if (!address) {
    console.log('[AMP] ✗ Could not find address in header');
    return;
  }
  
  console.log('[AMP] Target address:', address);
  
  // Search for elements containing "miljö" (case insensitive)
  const allElements = document.querySelectorAll(
    'button, div[role="button"], li, span, div'
  );
  
  let miljoElement = null;
  for (const elem of allElements) {
    const text = elem.textContent.toLowerCase();
    if (text.includes('miljö') && text.includes('parkering')) {
      miljoElement = elem;
      console.log('[AMP] ✓ Found Miljöparkering element:', elem.textContent.substring(0, 50));
      break;
    }
  }
  
  if (!miljoElement) {
    console.log('[AMP] ✗ Miljöparkering element not found');
    console.log('[AMP] Looking for search input as fallback...');
    findSearchInput(address);
    return;
  }
  
  // Try to click on the element or its parent button
  const clickable = miljoElement.closest('button') || 
                    miljoElement.closest('[role="button"]') || 
                    miljoElement.parentElement;
  
  if (clickable && clickable.tagName !== 'BODY') {
    console.log('[AMP] ✓ Found clickable parent, clicking...');
    clickable.click();
    setTimeout(() => toggleLayerVisibility(address), 500);
  } else {
    console.log('[AMP] ✗ Could not find clickable element');
    findSearchInput(address);
  }
}

function toggleLayerVisibility(address) {
  console.log('[AMP] Phase 3: Toggling layer visibility...');
  injectionPhase = 3;
  
  // Look for visibility toggle button near Miljöparkering
  const buttons = document.querySelectorAll('button');
  let toggleBtn = null;
  
  for (const btn of buttons) {
    if (btn.title?.includes('synlighet') || 
        btn.title?.includes('visibility') ||
        btn.getAttribute('aria-label')?.includes('synlighet')) {
      // Check if it's near any text containing "miljö"
      const container = btn.closest('li') || btn.closest('div[class*="item"]');
      if (container && container.textContent.toLowerCase().includes('miljö')) {
        toggleBtn = btn;
        console.log('[AMP] ✓ Found visibility toggle button');
        break;
      }
    }
  }
  
  if (toggleBtn) {
    console.log('[AMP] ✓ Clicking visibility toggle...');
    toggleBtn.click();
    setTimeout(() => findSearchInput(address), 300);
  } else {
    console.log('[AMP] ⚠ Could not find visibility toggle, proceeding to search...');
    findSearchInput(address);
  }
}

function findSearchInput(address) {
  console.log('[AMP] Phase 4: Looking for search input...');
  injectionPhase = 4;
  
  // Try multiple selectors for search input
  const searchSelectors = [
    'input[placeholder*="Sök"]',
    'input[placeholder*="Search"]',
    'input[type="search"]',
    'input[class*="search"]',
    'input[aria-label*="Sök"]',
    '.ol-search input',
    '[class*="search"] input',
    'input[name*="search"]'
  ];
  
  let searchInput = null;
  for (const selector of searchSelectors) {
    searchInput = document.querySelector(selector);
    if (searchInput) {
      console.log('[AMP] ✓ Found search input with selector:', selector);
      break;
    }
  }
  
  if (!searchInput) {
    console.log('[AMP] ✗ Search input not found in DOM');
    console.log('[AMP] Available inputs:', document.querySelectorAll('input').length);
    // List all inputs for debugging
    document.querySelectorAll('input').forEach((inp, i) => {
      console.log(`[AMP]   Input ${i}:`, inp.type, inp.placeholder, inp.className);
    });
    return;
  }
  
  console.log('[AMP] ✓ Injecting address:', address);
  injectAddress(searchInput, address);
}

function injectAddress(input, address) {
  console.log('[AMP] Phase 5: Injecting address into search...');
  injectionPhase = 5;
  
  try {
    // Focus the input
    input.focus();
    input.click();
    
    // Clear any existing value
    input.value = '';
    
    // Type the address
    input.value = address;
    
    // Trigger input events
    const events = [
      new Event('input', { bubbles: true }),
      new Event('change', { bubbles: true }),
      new Event('keydown', { key: 'Enter', bubbles: true }),
      new KeyboardEvent('keydown', {
        key: 'Enter',
        code: 'Enter',
        keyCode: 13,
        bubbles: true
      })
    ];
    
    events.forEach(evt => input.dispatchEvent(evt));
    
    console.log('[AMP] ✓ Address injected successfully!');
    console.log('[AMP] Injection sequence complete');
    
  } catch (err) {
    console.log('[AMP] ✗ Injection error:', err.message);
  }
}

// Set start time
window.injectionStart = Date.now();

// Expose for debugging
window.ampInjection = {
  phase: () => injectionPhase,
  retry: startInjectionSequence,
  debug: () => {
    console.log('AMP Debug Info:');
    console.log('- Menu button:', document.querySelector(BUTTON_IDS.MENU));
    console.log('- All inputs:', document.querySelectorAll('input').length);
    console.log('- Layer list items:', document.querySelectorAll('li[class*="item"]').length);
    console.log('- Button count:', document.querySelectorAll('button').length);
  }
};

console.log('[AMP] Injection script initialized. Debug: window.ampInjection');
</script>